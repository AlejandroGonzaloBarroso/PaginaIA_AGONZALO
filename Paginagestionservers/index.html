<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBox Controller - Versión Estable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        iframe { border: none; width: 100%; height: 100%; background: #ffffff; }
        
        .sidebar-btn { 
            display: flex; align-items: center; gap: 0.75rem; 
            padding: 0.75rem 1rem; width: 100%; 
            text-align: left; border-radius: 0.5rem; 
            transition: all 0.2s; color: #94a3b8; font-size: 0.875rem;
            margin-bottom: 0.25rem;
            border: 1px solid transparent;
        }
        .sidebar-btn:hover { background-color: #1e293b; color: #f1f5f9; border-color: #334155; }
        .sidebar-btn.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); border-color: #3b82f6; }

        .data-card {
            background-color: #020617;
            border: 1px solid #1e293b;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .data-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%;
        }
        .card-blue::before { background-color: #3b82f6; }
        .card-purple::before { background-color: #a855f7; }

        .data-label { color: #64748b; font-weight: bold; text-transform: uppercase; font-size: 0.65rem; }
        .data-value { color: #e2e8f0; font-family: 'Courier New', monospace; user-select: all; cursor: pointer; }
        .data-value:hover { color: #fff; text-decoration: underline; }

        /* Modal Styles */
        #fix-modal { transition: opacity 0.2s ease; }
        #fix-modal.hidden { opacity: 0; pointer-events: none; }
        #fix-modal.visible { opacity: 1; pointer-events: auto; }

        .status-dot { height: 8px; width: 8px; border-radius: 50%; background-color: #ef4444; display: inline-block; margin-right: 6px; box-shadow: 0 0 5px rgba(239,68,68,0.5); }
        .status-dot.online { background-color: #10b981; box-shadow: 0 0 5px rgba(16,185,129,0.5); }
    </style>
</head>
<body>

    <!-- CABECERA -->
    <nav class="bg-slate-900 border-b border-slate-700 h-16 flex items-center justify-between px-6 shrink-0 z-50 shadow-md">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/20">
                <i data-lucide="network" class="text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-white leading-tight">VBox Master Controller</h1>
                <div class="text-[10px] text-slate-400 font-mono flex items-center gap-2">
                    <span id="global-status" class="text-rose-500 font-bold">● DESCONECTADO</span>
                    <span class="text-slate-600">|</span>
                    <span>Modo: 127.0.0.1 (IPv4 Forced)</span>
                </div>
            </div>
        </div>
        
        <!-- Botones de Acción -->
        <div class="flex items-center gap-3">
            <button onclick="toggleModal()" class="flex items-center gap-2 bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded text-xs font-bold shadow-lg transition animate-pulse" id="repair-btn">
                <i data-lucide="wrench" width="14"></i> ¿PROBLEMAS? CLIC AQUÍ
            </button>

            <div class="h-6 w-px bg-slate-700 mx-1"></div>

            <div class="flex gap-2">
                <!-- Usamos 127.0.0.1 para evitar problemas de DNS local -->
                <a href="https://127.0.0.1:9001" target="_blank" class="text-[10px] bg-slate-800 border border-slate-600 hover:bg-slate-700 px-3 py-1.5 rounded text-slate-300 transition flex items-center gap-2 group">
                    <span class="status-dot" id="dot-s1"></span>
                    S1 (9001) <i data-lucide="external-link" width="10" class="opacity-0 group-hover:opacity-100"></i>
                </a>
                <a href="https://127.0.0.1:9002" target="_blank" class="text-[10px] bg-slate-800 border border-slate-600 hover:bg-slate-700 px-3 py-1.5 rounded text-slate-300 transition flex items-center gap-2 group">
                    <span class="status-dot" id="dot-s2"></span>
                    S2 (9002) <i data-lucide="external-link" width="10" class="opacity-0 group-hover:opacity-100"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- CUERPO PRINCIPAL -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- BARRA LATERAL (MENÚ) -->
        <div class="w-72 bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-6 shrink-0 overflow-y-auto">
            
            <!-- SERVER 1 MENU -->
            <div>
                <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-3 px-2 flex items-center gap-2">
                    <i data-lucide="server" width="14"></i> Server 1 (Archivos)
                </h2>
                <div class="space-y-1">
                    <button onclick="loadFrame('https://127.0.0.1:9001', this, 'Monitor S1')" class="sidebar-btn active">
                        <i data-lucide="activity" width="16"></i> Monitor Sistema
                    </button>
                    <button onclick="loadFrame('http://127.0.0.1:8001', this, 'Archivos Web')" class="sidebar-btn">
                        <i data-lucide="folder-open" width="16"></i> Gestor Archivos
                    </button>
                    
                    <!-- DATOS COMPLETOS SERVER 1 -->
                    <div class="data-card card-blue">
                        <div class="mb-2 border-b border-slate-800 pb-1 text-slate-400 font-bold flex justify-between">
                            <span>WEB LOGIN</span>
                            <i data-lucide="lock" width="10"></i>
                        </div>
                        <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-1">
                            <span class="data-label">User:</span> <span class="data-value text-yellow-400" onclick="copy(this)">admin</span>
                            <span class="data-label">Pass:</span> <span class="data-value text-yellow-400" onclick="copy(this)">admin@123</span>
                        </div>
                        <div class="mt-2 border-t border-slate-800 pt-1">
                            <span class="data-label block mb-0.5">Ruta Windows (SMB):</span>
                            <code class="data-value text-emerald-400 block bg-slate-800 p-1 rounded" onclick="copy(this)">\\127.0.0.1</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SERVER 2 MENU -->
            <div>
                <h2 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-3 px-2 flex items-center gap-2">
                    <i data-lucide="database" width="14"></i> Server 2 (Datos)
                </h2>
                <div class="space-y-1">
                    <button onclick="loadFrame('https://127.0.0.1:9002', this, 'Monitor S2')" class="sidebar-btn">
                        <i data-lucide="activity" width="16"></i> Monitor Sistema
                    </button>
                    <button onclick="loadFrame('http://127.0.0.1:8002', this, 'SQL Admin')" class="sidebar-btn">
                        <i data-lucide="database" width="16"></i> Gestor SQL
                    </button>

                    <!-- DATOS COMPLETOS SERVER 2 -->
                    <div class="data-card card-purple">
                        <div class="mb-2 border-b border-slate-800 pb-1 text-slate-400 font-bold flex justify-between">
                            <span>SQL LOGIN</span>
                            <i data-lucide="key" width="10"></i>
                        </div>
                        <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-1">
                            <span class="data-label">Host:</span> <span class="data-value">127.0.0.1</span>
                            <span class="data-label">User:</span> <span class="data-value text-yellow-400" onclick="copy(this)">tu_usuario</span>
                            <span class="data-label">Pass:</span> <span class="data-value text-yellow-400" onclick="copy(this)">tu_password</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto text-[10px] text-slate-600 text-center">
                Clic en los textos amarillos para copiar.
            </div>

        </div>

        <!-- ÁREA DE VISUALIZACIÓN -->
        <div class="flex-1 flex flex-col bg-slate-800 relative">
            
            <!-- Barra de estado del frame -->
            <div class="h-10 bg-slate-800 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
                <div class="flex items-center gap-2 text-sm text-white font-medium" id="frame-title">
                    <i data-lucide="activity" width="16" class="text-blue-400"></i>
                    Monitor S1
                </div>
                <div class="flex gap-2">
                    <a id="ext-link" href="https://127.0.0.1:9001" target="_blank" class="text-xs text-blue-400 hover:text-white flex items-center gap-1 hover:underline">
                        <i data-lucide="external-link" width="12"></i> Abrir en pestaña nueva
                    </a>
                    <button onclick="document.getElementById('main-frame').contentWindow.location.reload();" class="text-slate-400 hover:text-white" title="Recargar">
                        <i data-lucide="refresh-cw" width="14"></i>
                    </button>
                </div>
            </div>

            <!-- IFRAME PRINCIPAL -->
            <div class="flex-1 relative w-full h-full bg-slate-100">
                
                <!-- Overlay de Ayuda Inteligente -->
                <div id="help-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-0 text-center px-4">
                    <div class="bg-slate-800 p-8 rounded-xl border border-slate-700 shadow-2xl max-w-lg">
                        <div class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500 animate-bounce">
                            <i data-lucide="lock" width="32"></i>
                        </div>
                        <h3 class="text-white font-bold text-xl mb-2">Conexión Bloqueada por Seguridad</h3>
                        <p class="text-slate-400 text-sm mb-6 leading-relaxed">
                            Los navegadores bloquean las webs locales (127.0.0.1) dentro de otra web hasta que las apruebas.
                        </p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <a href="https://127.0.0.1:9001" target="_blank" class="block bg-slate-700 hover:bg-slate-600 border border-slate-600 p-3 rounded-lg text-left group transition">
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Paso 1</div>
                                <div class="text-sm text-white font-bold flex items-center gap-2 group-hover:text-blue-400">
                                    Aprobar Server 1 <i data-lucide="arrow-right" width="14"></i>
                                </div>
                            </a>
                            <a href="https://127.0.0.1:9002" target="_blank" class="block bg-slate-700 hover:bg-slate-600 border border-slate-600 p-3 rounded-lg text-left group transition">
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Paso 2</div>
                                <div class="text-sm text-white font-bold flex items-center gap-2 group-hover:text-purple-400">
                                    Aprobar Server 2 <i data-lucide="arrow-right" width="14"></i>
                                </div>
                            </a>
                        </div>
                        
                        <div class="text-xs text-slate-500 bg-black/20 p-2 rounded">
                            En la nueva ventana: <b>Configuración Avanzada</b> → <b>Acceder a 127.0.0.1 (No seguro)</b>.
                        </div>
                    </div>
                </div>

                <!-- El Frame Real -->
                <iframe id="main-frame" src="https://127.0.0.1:9001" class="relative z-10 w-full h-full" 
                        sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-modals"
                        onload="hideOverlay()"></iframe>
            </div>
        </div>

    </div>

    <!-- MODAL DE REPARACIÓN -->
    <div id="fix-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-3xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b border-slate-800 bg-slate-800 rounded-t-xl">
                <div>
                    <h3 class="text-white font-bold flex items-center gap-2 text-lg">
                        <i data-lucide="wrench" class="text-amber-500"></i> Solución Definitiva de Conexión
                    </h3>
                    <p class="text-xs text-slate-400 mt-1">Sigue estos pasos si ves "Conexión Rechazada" dentro de los recuadros.</p>
                </div>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-white bg-slate-700 p-1 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-8 text-sm text-slate-300">
                
                <!-- FIX 1: VIRTUALBOX -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h4 class="text-white font-bold mb-2 text-base">PASO 1: VirtualBox (Reenvío de Puertos)</h4>
                    <p class="mb-2 text-slate-400">Asegúrate de que estas reglas existen en <b>Configuración > Red > Avanzadas > Reenvío</b>:</p>
                    <table class="w-full text-xs text-left mb-2 bg-black/40 rounded overflow-hidden">
                        <thead class="bg-slate-800 text-slate-400"><tr><th class="p-2">Server</th><th class="p-2">IP Anfitrión</th><th class="p-2">Puerto Anfitrión</th><th class="p-2 text-amber-400">Puerto Invitado</th></tr></thead>
                        <tbody class="divide-y divide-slate-800">
                            <tr><td class="p-2">S1</td><td class="p-2">127.0.0.1</td><td class="p-2">9001</td><td class="p-2 font-bold text-white">9090</td></tr>
                            <tr><td class="p-2">S1</td><td class="p-2">127.0.0.1</td><td class="p-2">8001</td><td class="p-2 font-bold text-white">80</td></tr>
                            <tr><td class="p-2">S2</td><td class="p-2">127.0.0.1</td><td class="p-2">9002</td><td class="p-2 font-bold text-white">9090</td></tr>
                            <tr><td class="p-2">S2</td><td class="p-2">127.0.0.1</td><td class="p-2">8002</td><td class="p-2 font-bold text-white">80</td></tr>
                        </tbody>
                    </table>
                    <p class="text-[10px] text-amber-500">* ¡Deja la "IP Invitado" vacía!</p>
                </div>

                <!-- FIX 2: COMANDOS -->
                <div class="border-l-4 border-emerald-500 pl-4">
                    <h4 class="text-white font-bold mb-2 text-base">PASO 2: Permisos de Incrustación (Terminal)</h4>
                    <p class="mb-2 text-slate-400">Copia y pega este comando mágico en la terminal de <b>AMBOS</b> servidores Ubuntu/Lubuntu:</p>
                    <div class="bg-black p-4 rounded border border-slate-700 font-mono text-xs text-emerald-400 relative group break-all">
                        echo -e "[WebService]\nAllowUnencrypted=true\nOrigins = https://127.0.0.1:9001 https://127.0.0.1:9002 http://127.0.0.1:8001 http://127.0.0.1:8002 file://" | sudo tee /etc/cockpit/cockpit.conf && sudo systemctl restart cockpit
                        <button onclick="copyText(this)" class="absolute top-2 right-2 bg-slate-800 text-white px-3 py-1 rounded text-[10px] opacity-0 group-hover:opacity-100 transition font-sans font-bold">COPIAR</button>
                    </div>
                </div>

                <div class="text-center pt-2">
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-bold transition shadow-lg shadow-blue-900/50">
                        Hecho esto, RECARGAR PÁGINA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        function loadFrame(url, btn, title) {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const frame = document.getElementById('main-frame');
            frame.src = 'about:blank';
            setTimeout(() => { frame.src = url; }, 50);

            document.getElementById('frame-title').innerHTML = `${btn.innerHTML} <span class="ml-2 text-slate-500 text-xs font-normal">(${url})</span>`;
            document.getElementById('ext-link').href = url;
            
            // Show overlay initially
            document.getElementById('help-overlay').style.zIndex = "5";
            setTimeout(() => lucide.createIcons(), 100);
        }

        function hideOverlay() {
            // Only hides if content loads successfully
        }

        function toggleModal() {
            const modal = document.getElementById('fix-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('visible'), 10);
            } else {
                modal.classList.remove('visible');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function copy(element) {
            const text = element.innerText;
            navigator.clipboard.writeText(text);
            const original = element.style.color;
            element.style.color = '#34d399'; // Green
            setTimeout(() => { element.style.color = original; }, 200);
        }

        function copyText(btn) {
            const text = btn.parentElement.innerText.replace('COPIAR', '').trim();
            navigator.clipboard.writeText(text);
            btn.innerText = "¡COPIADO!";
            setTimeout(() => btn.innerText = "COPIAR", 2000);
        }

        // Auto-Check Status
        function checkStatus() {
            // Simple ping by image loading
            const img = new Image();
            img.onload = () => {
                document.getElementById('global-status').innerHTML = '● CONECTADO';
                document.getElementById('global-status').className = 'text-emerald-500 font-bold';
                document.getElementById('dot-s1').classList.add('online');
                document.getElementById('repair-btn').classList.remove('animate-pulse');
            };
            img.onerror = () => {
                // If SSL error or blocked, it triggers error but might be technically online.
                // We assume offline if instant fail.
            };
            img.src = "https://127.0.0.1:9001/favicon.ico?" + new Date().getTime();
        }
        
        setInterval(checkStatus, 5000);
        checkStatus();

    </script>
</body>
</html>